# Выпускной проект курса "Data Engineer" от OTUS

## Предварительная архитектура проекта

![Предварительная архитектура проекта - из папки](docs/diagrams/project_architecture.png)

## Особенности реализации

Проект запускается на сервере в защищенной инфраструктуре: доступ из Интернета к серверу закрыт, у сервера есть доступ в Интернет.

### Dagster

Версия Dagster 1.10.14 на основе образа python:3.12-alpine c хранением настроек в базе PostgreSQL, и подключением пользовательского кода в виде внешнего тома для удобства отладки и внесения изменений.

#### Сбор данных

1. Используется два asset:

* **fetch_usd_rate_from_ligovka** - сбор цен купли и продажи USD при обмене от $1000 с сайта ligovka.ru;
* **fetch_usd_rate_from_cbr** - сбор референсного курса USDRUB на следующий день через API ЦБ РФ:

1. Созданы раздельные расписания:

* для **fetch_usd_rate_from_ligovka** - запуск каждые три часа, так как обновления происходят нерегулярно;
* для **fetch_usd_rate_from_cbr** - запуск каждый день в 19:00 по московскому времени.

1. Asset'ы имеют следующие возможности:

* при необходимости создание таблицы, куда осуществляется запись, sql-процедура вынесена в константу для надежности;
* обработка ошибок для случаев, когда курс недоступен;
* правильное протоколирование всех операций;
* возвращение метаданных с курсом и датой в случае успеха;
* используют общие параметры подключения к базе данных;

1. Asset'ы будут:

* возвращать пустой результат MaterializeResult, если ставка недоступна;
* выводить предупреждения об ошибках HTTP;
* заносить в журнал ошибки при любых других исключениях;
* сохранять курс в базе данных только тогда, когда он доступен.

### PostgreSQL

Официальный образ PostgreSQL 17.5-bookworm с указанием логина и пароля для администратора, а также ограничением выделенных ресурсов.

### ClickHouse

2 экземпляра ClickHouse с использованием 3 выделенных ClickHouse Keeper: 1 шард с репликацией между clickhouse-01 и clickhouse-02. Версия 25.4.

Информацию о терминологии, конфигурации и тестировании можно найти [в документации](https://clickhouse.com/docs/en/architecture/replication).

### Metabase

Официальный образ MetaBase v0.54.5.3 c хранением настроек в базе PostgreSQL.
