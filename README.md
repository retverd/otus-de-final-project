# Выпускной проект курса "Data Engineer" от OTUS

## Архитектура проекта

![Архитектура проекта](docs/diagrams/project_architecture.png)

## Особенности реализации

Проект запускается на сервере в защищенной инфраструктуре: доступ из Интернета к серверу закрыт, у сервера есть доступ в Интернет.

### Dagster

Версия Dagster 1.10.14 на основе образа python:3.12-alpine c хранением настроек в базе PostgreSQL, и подключением пользовательского кода в виде внешнего тома для удобства отладки и внесения изменений.

#### Сбор данных

1. Используется два asset:

* **fetch_usd_rate_from_ligovka** - сбор цен купли и продажи USD при обмене от $1000 с сайта ligovka.ru;
* **fetch_usd_rate_from_cbr** - сбор референсного курса USDRUB на следующий день через API ЦБ РФ:

2. Созданы раздельные расписания:

* для **fetch_usd_rate_from_ligovka** - запуск каждые три часа, так как обновления происходят нерегулярно;
* для **fetch_usd_rate_from_cbr** - запуск каждый день в 19:00 по московскому времени.

3. Asset'ы имеют следующие возможности:

* при необходимости создание таблицы, куда осуществляется запись, sql-процедура вынесена в константу для надежности;
* обработка ошибок для случаев, когда курс недоступен;
* правильное протоколирование всех операций;
* возвращение метаданных с курсом и датой в случае успеха;
* используют общие параметры подключения к базе данных;

4. Asset'ы будут:

* возвращать пустой результат MaterializeResult, если ставка недоступна;
* выводить предупреждения об ошибках HTTP;
* заносить в журнал ошибки при любых других исключениях;
* сохранять курс в базе данных только тогда, когда он доступен.

#### Нормализация данных

1. Используется два asset:

* **load_cbr_data_to_dv** зависит от **fetch_usd_rate_from_cbr**, переносит в Data Vault данные от ЦБ РФ;
* **load_ligovka_data_to_dv** зависит от **fetch_usd_rate_from_ligovka**, переносит в Data Vault данные от обменника Лиговка;

2. Отдельного расписания нет, запускается после завершения работы вышестоящего asset.

3. Обработка данных:

* Для ЦБ РФ создается одна запись с типом курса 'reference';
* Для обменника Лиговка создаются две записи: 'buy' и 'sell';

4. Оптимизация:

* Загружаются только новые данные (сравнение по timestamp);
* Используются UPSERT операции для предотвращения дублирования, дубликаты игнорируются;
* Хеш-ключи генерируются на основе бизнес-ключей.

5. Обработка ошибок:

* Все операции выполняются в транзакции;
* Логирование ошибок и успешных операций;
* Корректное закрытие соединений.

6. Масштабируемость:

* Структура позволяет легко добавлять новые источники;
* Поддерживается историчность данных;
* Сохраняются все метаданные.

#### Подготовка данных

1. Используется один asset:

* **create_data_marketing_views** зависит от **load_cbr_data_to_dv** и **load_ligovka_data_to_dv**, обеспечивает наличие представления с витриной данных и доступ к этому представлению ClickHouse.

2. Отдельного расписания нет, запускается после завершения работы любого из вышестоящих asset.

### PostgreSQL

Официальный образ PostgreSQL 17.5-bookworm с указанием логина и пароля для администратора, а также ограничением выделенных ресурсов.

### ClickHouse

2 экземпляра ClickHouse с использованием 3 выделенных ClickHouse Keeper: 1 шард с репликацией между clickhouse-01 и clickhouse-02. Версия 25.4.

Информацию о терминологии, конфигурации и тестировании можно найти [в документации](https://clickhouse.com/docs/en/architecture/replication).

#### Загрузка данных

На любой реплике кластера ClickHouse выполнить следующий запрос:

```sql
CREATE NAMED COLLECTION postgres_creds_2 ON CLUSTER cluster_1S_2R AS
host='postgres',
port='5432',
db='data_db',
user=...,
password=...,
schema='data_marketing';
```

Затем создать представление в ClickHouse, получающее данные из PostgreSQL:

```sql
CREATE VIEW default.exchange_rates ON CLUSTER cluster_1S_2R
AS SELECT * FROM postgresql(postgres_creds, table='vw_exchange_rate_value');
```

<mark>Не смог заставить заработать named_collection, прописанные в конфигурационном файле /etc/clickhouse-server/config.d/named_collections.xml</mark> 

### Metabase

Официальный образ MetaBase v0.54.5.3 c хранением настроек в базе PostgreSQL.

#### Визуализация данных

Настроить подключение к любой реплике ClickHouse, подготовить дашборд на основе имеющихся данных.
